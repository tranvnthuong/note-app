const WEBSERVER="https://abalone-common-soldier.glitch.me",WEBHOSTING="https://tranvnthuong.github.io/note-app";let db,sortNotesBy;function openDatabase(){return new Promise(((e,t)=>{const o=indexedDB.open("NotesApp",1);o.onupgradeneeded=function(e){if(db=e.target.result,!db.objectStoreNames.contains("notes")){const e=db.createObjectStore("notes",{keyPath:"id",autoIncrement:!0});e.createIndex("date","isoDate",{unique:!1}),e.createIndex("title","titleText",{unique:!1}),e.createIndex("content","textContent",{unique:!1})}},o.onsuccess=function(t){db=t.target.result,e(db)},o.onerror=function(){t("Failed to open IndexedDB.")}}))}async function init(){try{db=await openDatabase();let e=localStorage.getItem("sortby")??"title";document.getElementById("sortNotes").querySelectorAll("option").forEach((t=>{t.value===e&&t.setAttribute("selected",!0)})),sortNotesBy=e,displayNotes(sortNotesBy),getNoteInUrlParameter()}catch(e){console.error(e)}}init();let translations={};async function fetchLanguageData(e){try{const t=await fetch(`./locales/${e}.json`);if(!t.ok)throw new Error(`Language file not found: ${e}`);return await t.json()}catch(e){return console.error(e),{}}}async function updateLanguageHtml(e){const t=document.querySelectorAll("[data-i18n]:not(input):not(button:not(#multiSelect))"),o=document.querySelectorAll("input[data-i18n]"),n=document.querySelectorAll("button[data-i18n]");translations=await fetchLanguageData(e),t.forEach((e=>{const t=e.getAttribute("data-i18n");translations[t]&&(e.textContent=translations[t])})),o.forEach((e=>{const t=e.getAttribute("data-i18n");translations[t]&&(e.placeholder=translations[t])})),n.forEach((e=>{const t=e.getAttribute("data-i18n");translations[t]&&(e.title=translations[t])})),reloadToolTips()}function putNoteWithoutWait(e){const t=db.transaction("notes","readwrite");t.objectStore("notes").put(e),t.oncomplete=function(){displayNotes(sortNotesBy)}}function getNote(e){return new Promise((t=>{db.transaction("notes","readonly").objectStore("notes").get(e).onsuccess=e=>{const o=e.target.result;t(o?{found:!0,message:"Found a note",data:o}:{found:!1,message:"Note not found"})}}))}async function getNoteInUrlParameter(){const e=new URLSearchParams(window.location.search),t=parseInt(e.get("note"),10);if(t){e.delete("note"),history.pushState({},"",window.location.pathname);if((await getNote(t)).found)showNote(t);else try{const e=await fetch(`${WEBSERVER}/api/notes/${t}`);if(e.ok){let t=await e.json();const o=db.transaction("notes","readwrite");o.objectStore("notes").put(t.note),o.oncomplete=function(){displayNotes(sortNotesBy),showNote(t.note.id)}}else{let t=await e.json();Swal.fire({icon:"error",title:translations.get_note_failed,text:t.message})}}catch(e){Swal.fire({icon:"error",title:translations.an_error,text:`${translations.error_details} ${e}`})}}}function displayNotes(e="title"){const t=db.transaction("notes","readonly").objectStore("notes").index(e).getAll();t.onsuccess=function(){const e=t.result,o=document.querySelector(".notes-list .note-container");if(o.innerHTML="",0==e.length)return document.querySelector(".empty-note").classList.remove("d-none"),void document.querySelector(".notes-toolbar").classList.add("d-none");document.querySelector(".empty-note").classList.add("d-none"),document.querySelector(".notes-toolbar").classList.remove("d-none"),e.forEach((e=>{const t=document.createElement("div");t.className="note-element col-6 col-md-4 col-lg-3",t.setAttribute("data-note-id",e.id),t.innerHTML=`<input class="note-checkbox" id="note${e.id}" value="${e.id}" type="checkbox">\n                    <div class="card" onclick="showNote(${e.id})">\n                    <div class="card-body">\n                        <h5 class="card-title">${e.titleText}</h5>\n                        <div class="card-text">${e.textContent}</div>\n                        <div class="d-flex justify-content-between align-items-center mt-2 mb-0">\n                            <p class="text-muted small mb-0">${e.dateString}</p>\n                            <button\n                              class="btn btn-danger btn-sm"\n                              onclick="deleteNote(${e.id}, event)"\n                            >\n                              <i class="fa fa-trash"></i>\n                            </button>\n                        </div>\n                    </div>\n                </div>`,o.appendChild(t)})),showCheckbox&&document.getElementById("multiSelect").click()}}document.getElementById("languageSelect").addEventListener("change",(e=>{const t=e.target.value;localStorage.setItem("use-language",t),updateLanguageHtml(t)})),document.getElementById("plus").addEventListener("click",(e=>{const t=document.getElementById("ul");t.classList.contains("animate")?(t.classList.remove("animate"),t.classList.add("hiding")):(t.classList.remove("hiding"),t.classList.add("animate"))})),document.addEventListener("DOMContentLoaded",(async function(){let e=localStorage.getItem("use-language");e?(document.getElementById("languageSelect").querySelectorAll("option").forEach((t=>{t.value===e&&t.setAttribute("selected",!0)})),updateLanguageHtml(e)):translations=await fetchLanguageData("vi"),reloadToolTips()})),document.getElementById("sortNotes").addEventListener("change",(e=>{let t=e.target.value;localStorage.setItem("sortby",t),sortNotesBy=t,displayNotes(t)}));const reloadToolTips=()=>{if(window.matchMedia("(hover: none)").matches)return;[].slice.call(document.querySelectorAll('[data-toggle="tooltip"]')).forEach((function(e){let t,o=new bootstrap.Tooltip(e);e.addEventListener("mouseenter",(()=>{o.show(),t=setTimeout((()=>o.hide()),1500)})),e.addEventListener("mouseleave",(()=>{clearTimeout(t),o.hide()}))}))},Toast=Swal.mixin({toast:!0,position:"top",customClass:{popup:"colored-toast"},showConfirmButton:!1,timer:1500,timerProgressBar:!1});function debounce(e,t){let o;return function(...n){clearTimeout(o),o=setTimeout((()=>e.apply(this,n)),t)}}function throttle(e,t){let o=0;return function(...n){const a=Date.now();a-o>=t&&(o=a,e.apply(this,n))}}let quill,clearSearchBtn=document.getElementById("clearSearch");function resetHighlight(e){const t=document.createTreeWalker(e,NodeFilter.SHOW_ALL,null,!1);for(;t.nextNode();){const e=t.currentNode;if("MARK"===e.tagName){const t=document.createTextNode(e.textContent);e.parentNode.replaceChild(t,e)}}}clearSearchBtn.onclick=function(){document.getElementById("searchInput").value="",clearSearchBtn.style.opacity="0",clearSearchBtn.style.pointerEvents="none",document.querySelectorAll("[data-note-id]").forEach((e=>e.classList.remove("d-none")));let e=document.querySelector(".show-note");e&&resetHighlight(e.querySelector("div"))},document.getElementById("searchInput").addEventListener("input",debounce((e=>{let t=document.querySelector(".show-note");if(""===e.target.value.trim())return clearSearchBtn.style.opacity="0",clearSearchBtn.style.pointerEvents="none",void(t.querySelector(".ql-container .ql-editor").innerHTML?resetHighlight(t.querySelector("div")):document.querySelectorAll("[data-note-id]").forEach((e=>e.classList.remove("d-none"))));clearSearchBtn.style.opacity="1",clearSearchBtn.style.pointerEvents="all";let o=e.target.value;if(t.querySelector(".ql-container .ql-editor").innerHTML){let e=t.querySelector("div");resetHighlight(e);const n=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1);for(;n.nextNode();){const e=n.currentNode;if(e.nodeValue.toLowerCase().includes(o.toLowerCase())){const t=e.nodeValue,n=new RegExp(`(${o})`,"gi"),a=t.replace(n,"<mark>$1</mark>"),r=document.createElement("div");for(r.innerHTML=a;r.firstChild;)e.parentNode.insertBefore(r.firstChild,e);e.parentNode.removeChild(e)}}const a=e.querySelector("mark");a&&a.scrollIntoView({behavior:"smooth",block:"center"})}else{db.transaction("notes","readonly").objectStore("notes").getAll().onsuccess=function(e){e.target.result.forEach((e=>{let t=e.titleText.toLowerCase();e.textContent.toLowerCase().includes(o)||t.includes(o)?document.querySelector(`div[data-note-id="${e.id}"]`).classList.remove("d-none"):document.querySelector(`div[data-note-id="${e.id}"]`).classList.add("d-none")}))}}}),1e3)),document.getElementById("quilljs").addEventListener("scroll",throttle((e=>{const t=document.querySelector("#quilljs .ql-toolbar"),o=document.querySelector("#quilljs").getBoundingClientRect();t.getBoundingClientRect().top<o.top?(t.style.position="fixed",t.style.top="0",t.style.width="80%",t.style.zIndex="10",t.style.backgroundColor="#f1f1f1"):(t.style.position="relative",t.style.top="auto",t.style.background="none")}),200));const toolbarOptions=[[{header:[1,2,3,4,!1]}],["bold","italic","underline","strike"],[{color:[]},{background:[]}],["link","image"],["blockquote","code-block"],[{align:[]}]];function showNote(e){let t=document.querySelector(".notes-list");t.style.overflowY="hidden",t.scrollTo({top:0,behavior:"smooth"}),clearSearchBtn.click(),document.getElementById("searchInput").setAttribute("placeholder",translations.search_in_note);db.transaction("notes","readonly").objectStore("notes").get(e).onsuccess=function(e){const o=e.target.result,n=document.querySelector(".notes-list .show-note");n.classList.remove("d-none"),n.querySelector(".updated").textContent=o.dateString,n.querySelector(".ql-container .ql-editor").innerHTML=o.content,document.getElementById("shareNote").onclick=function(e){shareNote(o.id,e.target)},document.getElementById("showEdit").onclick=function(){editNote(o.id)},document.getElementById("showDelete").onclick=function(){document.querySelector(".notes-list").style="",document.getElementById("searchInput").setAttribute("placeholder",translations.placeholder_search),n.querySelector(".ql-container .ql-editor").innerHTML="",n.classList.add("d-none"),deleteNote(o.id)},document.getElementById("closeShow").onclick=function(){document.querySelector(".notes-list").style="",document.getElementById("searchInput").setAttribute("placeholder",translations.placeholder_search),n.querySelector(".ql-container .ql-editor").innerHTML="",n.classList.add("d-none")};t.querySelector(".ql-container").querySelector(".ql-editor").querySelectorAll(".ql-code-block-container").forEach((e=>{e.className="highlight-code-container";const t=e.innerText.replace(/</g,"&lt;").replace(/>/g,"&gt;");e.innerHTML=`\n      <div class="code-language">\n        <i class="fa-solid fa-code"></i>\n        <p></p>\n      </div>\n      <button class="copy-btn">Copy</button>\n      <pre><code>\n        ${t}\n      </code></pre>\n      `;const o=e.querySelector("pre code");hljs.highlightElement(o),e.style.whiteSpace="nowrap",e.style.fontSize="initial",e.style.lineHeight="initial";const n=o.className.replace("hljs language-","");"undefined"!==n&&(e.querySelector(".code-language").querySelector("p").textContent=n),document.querySelectorAll(".copy-btn").forEach((e=>{e.addEventListener("click",(()=>{const t=e.nextElementSibling.querySelector("code").innerText;navigator.clipboard.writeText(t).then((()=>{e.innerText="Copied!",setTimeout((()=>{e.innerText="Copy"}),2e3)})).catch((e=>{console.error("Error copying text: ",e)}))}))}))}))}}function editNote(e){db.transaction("notes","readonly").objectStore("notes").get(e).onsuccess=function(t){const o=t.target.result,n=document.getElementById("popup");if(n.classList.contains("show"))return;document.getElementById("quilljs").innerHTML='<div id="editor"></div>',n.classList.remove("hide"),n.classList.add("show"),quill=new Quill("#editor",{modules:{toolbar:toolbarOptions},theme:"snow"}),quill.clipboard.dangerouslyPasteHTML(o.content),document.getElementById("popupHeader").textContent=translations.edit_note,document.getElementById("addAndShare").style.display="none";const a=document.getElementById("updateNote");a.style.display="initial",a.onclick=function(){updateNote(e),showNote(e)}}}function updateNote(e){const t=db.transaction("notes","readwrite"),o=t.objectStore("notes");o.get(e).onsuccess=function(n){const{shared:a}=n.target.result;let r,l,s=quill.root.innerHTML,i=(new DOMParser).parseFromString(s,"text/html"),c=i.querySelector("h1")||i.querySelector("h2")||i.querySelector("h3")||i.querySelector("h4");c&&(r=c.textContent,l=c.outerHTML,c.remove());let d=i.body.innerText,u=new Date,m=u.toLocaleString("vi-VN",{timeZone:"Asia/Ho_Chi_Minh",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1});const h={id:e,titleText:r,title:l,textContent:d,content:s,dateString:m,isoDate:u,shared:a};o.put(h),t.oncomplete=function(){document.getElementById("updateNote").style.display="none",document.getElementById("popupHeader").textContent=translations.new_note,document.getElementById("closePopup").click(),displayNotes(sortNotesBy)}}}document.getElementById("closePopup").addEventListener("click",(()=>{const e=document.getElementById("popup");e.classList.remove("show"),e.classList.add("hide"),document.getElementById("updateNote").style.display="none",document.getElementById("popupHeader").textContent="Ghi chú mới"}));let warning=!0;function deleteNote(e,t=null){t&&t.stopPropagation();new Promise((e=>{warning?Swal.fire({icon:"warning",text:translations.Confirm_note_deletion,input:"checkbox",inputPlaceholder:translations.do_not_repeat,showCancelButton:!0,cancelButtonText:translations.cancel,confirmButtonText:translations.delete}).then((t=>{t.isConfirmed?(t.value&&(warning=!1),e(!0)):e(!1)})):e(!0)})).then((t=>{if(t){const t=db.transaction("notes","readwrite");t.objectStore("notes").delete(e),t.oncomplete=function(){displayNotes(sortNotesBy)},t.onerror=function(){console.error("Failed to delete note.")}}}))}function deleteNoteIdb(e){const t=db.transaction("notes","readwrite");t.objectStore("notes").delete(e),t.oncomplete=function(){displayNotes(sortNotesBy)},t.onerror=function(){console.error("Failed to delete note.")}}function createModalController(e){const t=document.getElementById(e);let o=bootstrap.Modal.getInstance(t)||new bootstrap.Modal(t);return{show(){o.show()},hide(){o.hide()}}}function sharingModalContainer(e){const t=["verifySharing","shareWithId","sharePopup","qrLayout"];t.forEach((o=>{e===o?(e==t[2]?(document.getElementById("idNote").textContent=shareNotes.getIdNote(),document.getElementById("linkInput").value=`${WEBHOSTING}?note=${shareNotes.getIdNote()}`):e!=t[0]&&e!=t[1]||document.getElementById(e).querySelectorAll("input").forEach((e=>e.value="")),o==t[3]&&(document.getElementById("qrOutput").innerHTML=""),document.getElementById(e).classList.remove("d-none")):document.getElementById(o).classList.add("d-none")}))}function loadingCircleButton(e){const t=e.getBoundingClientRect(),o=document.createElement("div");o.className="spinner-border text-info",o.style.position="absolute",o.style.width=`${t.width+5}px`,o.style.height=`${t.width+5}px`,o.style.top=t.top+window.scrollY-2.5+"px",o.style.left=t.left+window.scrollX-2.5+"px",o.style.zIndex="1000";const n=document.createElement("div");return n.style.position="fixed",n.style.top="0",n.style.left="0",n.style.width="100%",n.style.height="100%",n.style.zIndex="999",n.style.pointerEvents="none",n.appendChild(o),document.body.appendChild(n),{show(){n.style.display="block",e.disabled=!0},hide(){n.style.display="none",e.disabled=!1,document.body.removeChild(n)}}}async function getCaptcha(){try{let e=await fetch(`${WEBSERVER}/api/notes/get-verification-code`);return e.ok?{ok:!0,data:await e.json()}:{ok:!1,status:e.status}}catch(e){return{ok:!1,status:e}}}const shareNotes=function(){let e,t={captcha:"",expired:Date.now()};return{putCaptcha(e){t=e},getCaptcha:()=>t,putIdNote(t){e=t},getIdNote:()=>e}}();let importModal,informationModal,blockSpam=!1;function validateCaptcha(e){return""===e.value.trim()?(Toast.fire({icon:"warning",title:translations.captcha_require}),!1):e.value.toLowerCase()!==shareNotes.getCaptcha().captcha?(Toast.fire({icon:"error",title:translations.wrong_captcha}),!1):!(shareNotes.getCaptcha().expired<Date.now())||(Toast.fire({icon:"error",title:translations.captcha_has_expired}),!1)}function shareNote(e,t){db.transaction("notes","readonly").objectStore("notes").get(e).onsuccess=async function(o){const n=o.target.result;if(shareNotes.putIdNote(e),n.shared)sharingModalContainer("sharePopup"),createModalController("shareModal").show();else{if(blockSpam)return void Toast.fire({icon:"warning",title:translations.wait_a_few_second});blockSpam=!0,sharingModalContainer("verifySharing");const e=loadingCircleButton(t);e.show();try{let e=await getCaptcha();if(e.ok){let t=e.data.data;shareNotes.putCaptcha(t),document.getElementById("cacha").textContent=t.captcha,createModalController("shareModal").show()}else Swal.fire({icon:"error",title:translations.sharing_error,text:`${translations.error_details} ${e.status}`})}catch(e){Swal.fire({icon:"error",title:translations.an_error,text:`${translations.error_details} ${e}`})}e.hide(),setTimeout((()=>blockSpam=!1),5e3)}}}function copyLink(){let e=document.getElementById("linkInput");e.select(),e.setSelectionRange(0,99999),navigator.clipboard.writeText(e.value),Toast.fire({icon:"success",title:translations.link_copied})}async function downloadNote(){const e=[],t=await getNote(shareNotes.getIdNote());if(t.found){e.push(t.data);const o=JSON.stringify(e,null,2),n=new Blob([o],{type:"application/json"}),a=URL.createObjectURL(n),r=document.createElement("a");r.href=a,r.download=t.data.titleText+".json",document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(a)}}function createQRLink(){let e=document.getElementById("qrOutput");if(e.innerHTML)e.innerHTML="",document.getElementById("qrLayout").classList.add("d-none");else{e.innerHTML="";new QRCode(e,{text:document.getElementById("linkInput").value,width:200,height:200,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H});document.getElementById("qrLayout").classList.remove("d-none")}}function sidebar(e){const t=document.getElementById("popup");switch(e){case"newNote":if(t.classList.contains("show"))return;document.getElementById("addAndShare").style.display="initial",document.getElementById("quilljs").innerHTML='<div id="editor"></div>',t.classList.remove("hide"),t.classList.add("show"),quill=new Quill("#editor",{modules:{toolbar:toolbarOptions},theme:"snow"}),quill.clipboard.dangerouslyPasteHTML(`<h1>${translations.title}</h1><p>${translations.content}</p>`);break;case"useCode":Swal.fire({title:translations.enter_note_code,input:"text",inputPlaceholder:translations.code_placeholder,inputAttributes:{autocapitalize:"off",autocomplete:"off"},showCancelButton:!0,cancelButtonText:translations.cancel,confirmButtonText:translations.search,showLoaderOnConfirm:!0,preConfirm:async e=>{if(""===e.trim())return Swal.showValidationMessage(translations.note_code_require);if(!e.match(/^\d{6}$/))return Swal.showValidationMessage(translations.six_numbers_require);e=parseInt(e,10);const t=db.transaction("notes","readonly").objectStore("notes").get(e);let o;const n=new Promise((e=>{t.onsuccess=t=>{o=t.target.result,e(!!o)}}));if(await n)return{message:"Found a note",note:o};try{const t=await fetch(`${WEBSERVER}/api/notes/${e}\n              `);if(!t.ok){let e=await t.json();return Swal.showValidationMessage(`\n                  ${e.message}\n                `)}return t.json()}catch(e){Swal.showValidationMessage(`\n                Request failed: ${e}\n              `)}},allowOutsideClick:()=>!Swal.isLoading()}).then((e=>{if(e.isConfirmed){Toast.fire({icon:"success",title:translations.get_note_success});const t=db.transaction("notes","readwrite");t.objectStore("notes").put(e.value.note),t.oncomplete=function(){displayNotes(sortNotesBy),showNote(e.value.note.id)}}}));break;case"importFile":importModal=createModalController("importModal"),importModal.show();break;case"language":document.getElementById("webInformation").classList.add("d-none"),document.getElementById("selectLanguage").classList.remove("d-none"),informationModal=createModalController("informationModal"),informationModal.show();break;case"info":document.getElementById("webInformation").classList.remove("d-none"),document.getElementById("selectLanguage").classList.add("d-none"),informationModal=createModalController("informationModal"),informationModal.show()}}function newNote(e=null){return new Promise(((t,o)=>{let n,a,r=quill.root.innerHTML,l=(new DOMParser).parseFromString(r,"text/html"),s=l.querySelector("h1")||l.querySelector("h2")||l.querySelector("h3")||l.querySelector("h4");s&&(n=s.innerText,a=s.outerHTML,s.remove());let i=l.body.innerText,c=new Date,d=c.toLocaleString("vi-VN",{timeZone:"Asia/Ho_Chi_Minh",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1});const u={id:e=e??Math.floor(899999*Math.random())+1e5,titleText:n,title:a,textContent:i,content:r,dateString:d,isoDate:c,shared:!1},m=db.transaction("notes","readwrite"),h=m.objectStore("notes");h.get(e).onsuccess=o=>{o.target.result?t({success:!1,message:"ID already existsy"}):(shareNotes.putIdNote(e),h.add(u),displayNotes(sortNotesBy),t({success:!0,message:"New note created successfully",data:u}))},m.onerror=function(e){console.error("Failed to add note."),o(e)},document.getElementById("closePopup").click()}))}function updateToggleSelectAllButton(){const e=document.querySelectorAll(".note-checkbox"),t=Array.from(e).every((e=>e.checked));document.getElementById("selectAll").innerHTML=t?'<i class="fa-regular fa-circle-check"></i>':'<i class="fa-solid fa-circle-check"></i>'}function updateActionButtons(){const e=document.querySelectorAll(".note-checkbox"),t=[document.getElementById("downloadSelected"),document.getElementById("deleteSelected")],o=Array.from(e).some((e=>e.checked));t.forEach((e=>e.disabled=!o))}document.querySelectorAll("#refreshCaptcha").forEach((e=>{e.addEventListener("click",(async()=>{if(blockSpam)Toast.fire({icon:"warning",title:translations.wait_a_few_second});else{blockSpam=!0;try{let e=await getCaptcha();if(e.ok){let t=e.data.data;shareNotes.putCaptcha(t),document.getElementById("cacha").textContent=t.captcha,document.getElementById("cacha2").textContent=t.captcha}else Swal.fire({icon:"error",title:translations.sharing_error,text:`${translations.error_details} ${e.status}`})}catch(e){Swal.fire({icon:"error",title:translations.an_error,text:`${translations.error_details} ${e}`})}setTimeout((()=>blockSpam=!1),5e3)}}))})),document.getElementById("submitSharing").addEventListener("click",(()=>{const e=document.getElementById("cachaIput");if(!validateCaptcha(e))return;let t=db.transaction("notes","readonly"),o=t.objectStore("notes");o.get(shareNotes.getIdNote()).onsuccess=async function(n){const a=n.target.result;try{let n=await fetch(`${WEBSERVER}/api/notes`,{method:"POST",headers:{"Content-Type":"application/json",Captcha:e.value},body:JSON.stringify(a)});if(n.ok){let e=await n.json();t=db.transaction("notes","readwrite"),o=t.objectStore("notes"),o.put(e.note),t.oncomplete=function(){sharingModalContainer("sharePopup")}}else{let e=await n.json();Swal.fire({icon:"error",title:translations.sharing_error,text:`${translations.error_details} ${e.message}`})}}catch(e){Swal.fire({icon:"error",title:translations.an_error,text:`${translations.error_details} ${e}`})}}})),document.getElementById("importfiles").addEventListener("change",(function(e){const t=e.target.files[0];if(t){if("application/json"!==t.type)return void Swal.fire({icon:"error",title:translations.import_failed,text:translations.json_format_require});const e=new FileReader;e.onload=function(e){try{const t=JSON.parse(e.target.result);t.forEach((e=>putNoteWithoutWait(e))),Swal.fire({icon:"success",title:translations.success,text:`${translations.import_text_1} (${t.length} ${translations.import_text_2})`}),importModal.hide()}catch(e){Swal.fire({icon:"error",title:translations.import_error,text:e.message})}},e.readAsText(t)}})),document.getElementById("addAndShare").addEventListener("click",(async e=>{const t=e.target;if(blockSpam)return void Toast.fire({icon:"warning",title:translations.wait_a_few_second});blockSpam=!0,sharingModalContainer("shareWithId");const o=loadingCircleButton(t);o.show();try{let e=await getCaptcha();if(e.ok){let t=e.data.data;shareNotes.putCaptcha(t),document.getElementById("cacha2").textContent=t.captcha,createModalController("shareModal").show(),document.getElementById("submitSharing2").onclick=async function(e){let t=document.getElementById("idNoteInput").value;if(t.length>1&&6!==t.length&&!t.match(/^\d*$/))return void Toast.fire({icon:"warning",title:translations.id_require_options});t.match(/^\d{6}$/)?t=parseInt(t,10):""===t.trim()&&(t=null);const o=document.getElementById("cachaIput2");if(!validateCaptcha(o))return;e.target.value="";const n=await newNote(t);if(n.success){const e=await fetch(`${WEBSERVER}/api/notes`,{method:"POST",headers:{"Content-Type":"application/json",captcha:o.value},body:JSON.stringify(n.data)});if(e.ok){putNoteWithoutWait((await e.json()).note),sharingModalContainer("sharePopup"),createModalController("shareModal").show()}else{let t=await e.json();Swal.fire({icon:"error",title:translations.sharing_error,text:t.message}),deleteNoteIdb(n.data.id)}}else Toast.fire({icon:"error",title:n.message})}}else Swal.fire({icon:"error",title:translations.sharing_error,text:`${translations.error_details} ${e.status}`})}catch(e){Swal.fire({icon:"error",title:translations.an_error,text:`${translations.error_details} ${e}`})}o.hide(),setTimeout((()=>blockSpam=!1),5e3)})),document.getElementById("addNote").addEventListener("click",(()=>{try{newNote()}catch(e){console.error(e)}})),document.getElementById("selectAll").addEventListener("click",(e=>{const t=document.querySelectorAll(".note-checkbox"),o=Array.from(t).every((e=>e.checked));t.forEach((e=>e.checked=!o)),updateActionButtons(),updateToggleSelectAllButton()})),document.getElementById("downloadSelected").addEventListener("click",(async e=>{const t=Array.from(document.querySelectorAll(".note-checkbox")).filter((e=>e.checked)),o=await Promise.all(t.map((async e=>(await getNote(parseInt(e.value,10))).data)));if(o.length>0){const e=JSON.stringify(o,null,2),t=new Blob([e],{type:"application/json"}),n=URL.createObjectURL(t),a=document.createElement("a");a.href=n,a.download=`backup-notes[length=${o.length}].json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n)}})),document.getElementById("deleteSelected").addEventListener("click",(()=>{const e=document.querySelectorAll(".note-checkbox"),t=Array.from(e).filter((e=>e.checked)).length,o=e.length==t?translations.delete_text:t;Swal.fire({icon:"warning",title:translations.delete_warning,text:`${translations.delete_warning_1} ${o} ${translations.delete_warning_2}`,showConfirmButton:!0,showCancelButton:!0}).then((t=>{t.isConfirmed&&e.forEach((e=>{e.checked&&deleteNoteIdb(parseInt(e.value,10))}))}))}));let showCheckbox=!1;document.getElementById("multiSelect").addEventListener("click",(e=>{const t=document.getElementById("selectAll"),o=[document.getElementById("downloadSelected"),document.getElementById("deleteSelected")],n=document.querySelectorAll(".note-checkbox");showCheckbox?(showCheckbox=!showCheckbox,e.target.textContent=translations.select,t.style.display="none",o.forEach((e=>e.style.display="none")),n.forEach((e=>{e.style.display="none",e.checked=!1}))):(showCheckbox=!showCheckbox,updateActionButtons(),e.target.textContent=translations.cancel,t.style="",o.forEach((e=>e.style="")),n.forEach((e=>{e.style.display="block",e.addEventListener("change",(()=>{updateToggleSelectAllButton(),updateActionButtons()}))})))}));const parent=document.querySelector(".popup"),child=document.getElementById("closePopup");parent.addEventListener("scroll",(()=>{const e=parent.getBoundingClientRect();child.getBoundingClientRect();parent.scrollTop>0?(child.style.position="fixed",child.style.top=`${e.top}px`):(child.style.position="absolute",child.style.top="0")}));